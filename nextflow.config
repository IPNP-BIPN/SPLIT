/*
 * ══════════════════════════════════════════════════════════════════════════════
 *  SPLIT — nextflow.config
 *  Allele-specific RNA-seq pipeline (STAR + SNPsplit + featureCounts)
 *  Optimized for local execution (Mac Studio / workstation)
 * ══════════════════════════════════════════════════════════════════════════════
 */

// ── Parameters ──────────────────────────────────────────────────────────────

params {

    // ── Input (one required) ────────────────────────────────────────────────
    input               = null          // Samplesheet CSV: sample,fastq_1,fastq_2
    fastq_dir           = null          // Directory containing *.fastq.gz
    sra_ids             = null          // SRA/GEO accessions (csv string or file, 1/line)

    // ── Output ──────────────────────────────────────────────────────────────
    outdir              = 'results'

    // ── Strains (must match column names in the MGP VCF) ────────────────────
    strain1             = 'CAST_EiJ'    // → genome1 in SNPsplit output
    strain2             = 'C57BL_6NJ'   // → genome2 in SNPsplit output

    // ── References (GRCm39 mouse, Ensembl/MGP defaults) ─────────────────────
    genome_url          = 'https://ftp.ebi.ac.uk/pub/ensemblorganisms/Mus_musculus/GCA_000001635.9/genome/softmasked.fa.gz'
    gtf_url             = 'https://ftp.ebi.ac.uk/pub/ensemblorganisms/Mus_musculus/GCA_000001635.9/ensembl/geneset/2023_04/genes.gtf.gz'
    vcf_url             = 'https://ftp.ebi.ac.uk/pub/databases/mousegenomes/REL-2112-v8-SNPs_Indels/mgp_REL2021_snps.vcf.gz'
    vcf_index_url       = 'https://ftp.ebi.ac.uk/pub/databases/mousegenomes/REL-2112-v8-SNPs_Indels/mgp_REL2021_snps.vcf.gz.csi'

    // Pre-existing references (skip download if provided)
    genome_fa           = null          // Pre-downloaded genome FASTA
    gtf                 = null          // Pre-downloaded GTF
    vcf                 = null          // Pre-downloaded VCF
    star_index_nmask    = null          // Pre-built STAR index (N-masked)
    star_index_ref      = null          // Pre-built STAR index (reference)
    snp_file            = null          // Pre-existing SNPsplit SNP file

    // ── STAR options ────────────────────────────────────────────────────────
    star_limit_genome_ram = 60000000000 // --limitGenomeGenerateRAM (60 GB)

    // ── Deduplication ───────────────────────────────────────────────────────
    dedup               = true          // Remove PCR duplicates (samtools markdup -r)

    // ── featureCounts ───────────────────────────────────────────────────────
    strandedness        = 0             // 0 = unstranded, 1 = forward, 2 = reverse
    force_se            = false         // Force single-end counting (skip -p flag)

    // ── Resources ───────────────────────────────────────────────────────────
    max_cpus            = Runtime.runtime.availableProcessors()
    max_memory          = '64 GB'
}


// ── Per-label resource allocation ───────────────────────────────────────────

process {

    errorStrategy = 'retry'
    maxRetries    = 1

    // Memory scales proportionally with --max_memory
    // low=6%, medium=12%, high=25%  (min floors to avoid trivial allocations)
    withLabel: 'process_low' {
        cpus   = 2
        memory = { "${Math.max(2, (params.max_memory.replace(' GB','') as int) * 6 / 100)} GB" }
    }

    withLabel: 'process_medium' {
        cpus   = { Math.min(4, params.max_cpus as int) }
        memory = { "${Math.max(4, (params.max_memory.replace(' GB','') as int) * 12 / 100)} GB" }
    }

    withLabel: 'process_high' {
        cpus   = { params.max_cpus }
        memory = { "${Math.max(8, (params.max_memory.replace(' GB','') as int) * 25 / 100)} GB" }
    }

    // STAR index generation needs more RAM for large genomes
    withName: 'STAR_INDEX' {
        memory = { "${Math.max(16, (params.max_memory.replace(' GB','') as int) * 50 / 100)} GB" }
    }
}


// ── Profiles ────────────────────────────────────────────────────────────────

profiles {

    standard {
        process.executor = 'local'
    }

    // Minimal resources for quick validation
    test {
        params {
            max_cpus              = 2
            max_memory            = '8 GB'
            star_limit_genome_ram = 8000000000
        }
        process {
            withLabel: 'process_low'    { memory = '2 GB' }
            withLabel: 'process_medium' { memory = '4 GB'; cpus = 2 }
            withLabel: 'process_high'   { memory = '6 GB'; cpus = 2 }
            withName:  'STAR_INDEX'     { memory = '6 GB' }
        }
    }
}


// ── Nextflow reports ────────────────────────────────────────────────────────

def trace_timestamp = new java.text.SimpleDateFormat("yyyy-MM-dd_HH-mm-ss").format(new java.util.Date())

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${trace_timestamp}.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${trace_timestamp}.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace_${trace_timestamp}.txt"
    fields  = 'task_id,hash,native_id,name,status,exit,submit,start,complete,duration,realtime,%cpu,rss,peak_rss'
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag_${trace_timestamp}.html"
}


// ── Manifest ────────────────────────────────────────────────────────────────

manifest {
    name            = 'IPNP-BIPN/SPLIT'
    author          = 'IPNP-BIPN'
    homePage        = 'https://github.com/IPNP-BIPN/SPLIT'
    description     = 'Allele-specific RNA-seq pipeline: STAR + SNPsplit + featureCounts'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04'
    version         = '1.0.0'
}
